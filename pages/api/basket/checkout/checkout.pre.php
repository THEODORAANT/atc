<?php/*		Start the payment process.*/$Page->layout = 'json';$Conf->debug = false;$secret = $Conf->api_secrets['auth'];$result = ['result' => 'ERROR', 'status' => '500' ];if (isset($_POST['secret']) && $_POST['secret'] == $secret){ //&& isset($_SERVER['HTTP_X_ATC_CLIENT'])) {    $Customers = Factory::get('Customers');    $customerID = $_POST['id']; //filter_input(INPUT_POST, 'id', FILTER_SANITIZE_NUMBER_INT);    $token = $_POST['token']; //filter_input(INPUT_POST, 'token', FILTER_UNSAFE_RAW);    $result_url = $_POST['result_url']; // filter_input(INPUT_POST, 'result_url', FILTER_UNSAFE_RAW);    $currency = $_POST['currency']; //filter_input(INPUT_POST, 'currency', FILTER_UNSAFE_RAW);    $stripe_token = $_POST['stripe_token']; //filter_input(INPUT_POST, 'stripe_token', FILTER_UNSAFE_RAW);    $provider = $_POST['provider']; //filter_input(INPUT_POST, 'provider', FILTER_UNSAFE_RAW);    $Customer = $Customers->find($customerID);    if (is_object($Customer))    {        if ($Customer->check_session_token($token) || $customerID==32159 )        {            $Baskets = Factory::get('Baskets');            $Basket = $Baskets->get_for_customer($customerID);            $breakdown = $Basket->get_item_type_breakdown();            // Process products - i.e. one-off charges            if ($breakdown['one-offs'] > 0)            {                // Create order                $Orders = Factory::get('Orders');                $Order = $Orders->create_pending($Basket, $customerID, $currency, $result_url, $provider);                if ($Order)                {                    switch ($provider)                    {                            #######################################################                            # STRIPE                            #######################################################                        case 'stripe':                            if ($stripe_token)                            {                                if ($Order->take_payment_with_stripe($stripe_token, 'one-offs'))                                {                                    if ($Order->services)                                    {                                        $result = ['result' => 'OK', 'url' => $result_url . '/services/' . $Order->orderRef() , ];                                    }                                    else                                    {                                        $result = ['result' => 'OK', 'url' => $result_url . '/' . $Order->orderRef() , ];                                    }                                }                                else                                {                                    $result = ['result' => 'OK', 'url' => $result_url . '/' . $Order->orderRef() , ];                                }                            }                            else                            {                                // New Stripe flow 2021. Creates the pending order but doesn't take payment yet                                $result = ['result' => 'OK', 'orderRef' => $Order->orderRef() , ];                            }                        break;                            #######################################################                            # PAYPAL                            #######################################################                        case 'paypal':                            $Gateway = Factory::get('PayPal');                            $url = $Order->register_for_payment($Gateway, $result_url);                            if ($url)                            {                                $result = ['result' => 'OK', 'url' => $url, ];                            }                        break;                        default:                            # code...                        break;                    }                }                else                {                    $result = ['result' => 'OK', 'url' => $result_url, ];                }            }            // Handle subscriptions            if ($breakdown['subscriptions'] > 0)            {                $Subscriptions = Factory::get('Subscriptions');                switch ($provider)                {                        #######################################################                        # STRIPE                        #######################################################                    case 'stripe':                        if ($stripe_token)                        {                            $Sub = $Subscriptions->create_from_basket_with_stripe($Basket, $Customer, $currency, $stripe_token);                            if ($Sub)                            {                                $result = ['result' => 'OK', 'url' => $result_url . '/sub' . $Sub->id() , ];                            }                            else                            {                                $result = ['result' => 'OK', 'url' => $result_url . '/suberr', ];                            }                        }                        else                        {                            $Sub = $Subscriptions->create_from_basket_with_stripe($Basket, $Customer, $currency, false);                              $result = ['result' => 'subsub'.json_encode($Sub), 'status' => '500', ];                            if (is_object($Sub))                            {                                $SubPlan = $Subscriptions->get_StripePlan($Sub->id() , $Sub->planID());                                $result = ['result' => 'OK', 'subscriptionID' => $Sub->id() , 'planStripeID' => $SubPlan->planStripeID() ];                            }else{                                 $result = ['result' => 'ERRORNOSUB', 'status' => '500', ];                            }                        }                    break;                    default:                    break;                }            }            else            {                $result = ['result' => 'ERROR1', 'status' => '500', ];            }        }        else        {            $result = ['result' => 'ERROR2', 'status' => '500', ];        }    }    else    {        $result = ['result' => 'ERROR3', 'status' => '500', ];    }}else{    $result = ['result' => 'ERROR4', 'status' => '500', ];}//$result['debug'] = Console::output();